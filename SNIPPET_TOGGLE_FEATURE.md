# ğŸ–¼ï¸ AI Snippet Preview Toggle Feature

## Overview
Added a toggle button that allows users to show/hide the AI-analyzed image snippets in the annotations list.

## What Changed

### 1. **State Management** (`apps/web/src/store/viewerStore.ts`)
- Added `showSnippets` boolean state (default: `true`)
- Added `toggleShowSnippets()` action to toggle the state

### 2. **UI Toggle Button** (`apps/web/src/components/ViewerToolbar.tsx`)
- Added "ğŸ–¼ï¸ Snippets" button in the toolbar (right side)
- Button shows as highlighted (primary) when snippets are visible
- Shows just "ğŸ–¼ï¸" icon when snippets are hidden
- Includes helpful tooltip: "Toggle AI snippet previews in annotations"

### 3. **Conditional Rendering** (`apps/web/src/components/AnnotationsList.tsx`)
- Snippet preview images now only render when `showSnippets` is `true`
- All other annotation data (label, confidence, description) always visible

## How It Works

1. **User clicks Annotate (3)** mode
2. **Draws a rectangle** on the image
3. **AI analyzes** the actual image region and returns:
   - Classification result
   - Confidence score
   - **Base64-encoded snippet** of what was analyzed
4. **Snippet appears** in the annotation card (if toggle is ON)

## User Experience

### Toggle ON (Default)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â— Galaxy                    â”‚
â”‚ AI Classified: 89% conf.    â”‚
â”‚ [rect] [89%] [user123]     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚  [Image Preview]     â”‚    â”‚ â† Snippet visible
â”‚ â”‚                      â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚ Size: 300x300               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Toggle OFF
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â— Galaxy                    â”‚
â”‚ AI Classified: 89% conf.    â”‚
â”‚ [rect] [89%] [user123]     â”‚
â”‚                             â”‚ â† No snippet shown
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Benefits

### âœ… **User Control**
- Users can hide snippets for cleaner UI
- Reduces visual clutter when working with many annotations
- Snippets can be toggled on to verify what AI analyzed

### âœ… **Performance**
- Base64 images still load but aren't rendered when hidden
- Lightweight toggle (pure UI state, no API calls)

### âœ… **Transparency**
- When enabled, users can see exactly what the AI analyzed
- Confirms that AI uses **actual image regions**, not pre-trained datasets
- Helps debug classification issues

## Technical Details

### State Flow
1. User clicks toggle button
2. `toggleShowSnippets()` flips boolean in Zustand store
3. All `AnnotationsList` components re-render
4. Snippet `<div>` conditionally renders based on `showSnippets` state

### Data Source
- Snippets come from `annotation.metadata.snippet_preview`
- Generated by AI service in `apps/ai/app/main.py` (lines 404-426)
- Format: `data:image/jpeg;base64,{base64_data}`
- Max preview size: 400x400 pixels (resized from original snippet)

### Storage
- Snippets are **not** stored in the database
- Only stored in frontend state during session
- On page refresh, annotations load without snippets (but AI can re-classify if needed)

## Example Code

### Toggle Button Location
```typescript
// apps/web/src/components/ViewerToolbar.tsx
<Button 
  variant={showSnippets ? "primary" : "ghost"} 
  size="sm" 
  onClick={toggleShowSnippets}
  title="Toggle AI snippet previews in annotations"
>
  {showSnippets ? "ğŸ–¼ï¸ Snippets" : "ğŸ–¼ï¸"}
</Button>
```

### Conditional Rendering
```typescript
// apps/web/src/components/AnnotationsList.tsx
{showSnippets && annotation.metadata?.snippet_preview && (
  <div className="mt-2">
    <img 
      src={annotation.metadata.snippet_preview as string}
      alt={annotation.label || "Annotation"}
      className="w-full max-w-[200px] rounded border border-gray-600"
    />
  </div>
)}
```

## Future Enhancements

### Possible Improvements:
1. **Persist toggle state** in localStorage
2. **Click to enlarge** snippet preview (modal/lightbox)
3. **Download snippet** as separate image file
4. **Compare snippets** side-by-side for multiple annotations
5. **Show snippet on hover** over annotation rectangle on canvas
6. **Snippet quality selector** (low/medium/high resolution)

## Testing

### Test Cases:
1. âœ… Toggle starts ON (snippets visible by default)
2. âœ… Click toggle â†’ snippets disappear
3. âœ… Click again â†’ snippets reappear
4. âœ… Toggle state persists across mode changes
5. âœ… Works with multiple annotations
6. âœ… No errors when annotation has no snippet data
7. âœ… Button visual state matches snippet visibility

## Summary

This feature gives users **full control** over snippet visibility, proving that the AI:
- âœ… Analyzes **actual image regions** (not pre-loaded data)
- âœ… Works with **any uploaded image**
- âœ… Provides **visual transparency** into AI decision-making

Users can now **verify** exactly what the AI sees! ğŸ¯
